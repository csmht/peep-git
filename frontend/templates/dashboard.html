{% extends "base.html" %}

{% block title %}ä¸»é¡µ - PEEP GIT{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<!-- ä»Šæ—¥ç»Ÿè®¡å¡ç‰‡ -->
<div class="today-summary-card cute-today-card">
    <div class="today-header">
        <h2 class="today-title">ğŸ“… ä»Šæ—¥æ¦‚è§ˆ</h2>
        <div class="header-actions">
            <button id="view-history-btn" class="btn-icon-only" title="æŸ¥çœ‹å†å²è®°å½•" onclick="toggleHistory()">
                ğŸ“–
            </button>
            <button id="refresh-today-btn" class="btn-icon-only" title="åˆ·æ–°ä»Šæ—¥è¯„ä»·">
                ğŸ”„
            </button>
        </div>
    </div>
    <div class="today-stats">
        <div class="today-stat">
            <div class="today-icon">ğŸ’</div>
            <div class="today-count" id="today-commits">-</div>
            <div class="today-label">ä»Šæ—¥æäº¤</div>
        </div>
        <div class="today-stat">
            <div class="today-icon">âœˆï¸</div>
            <div class="today-count" id="today-pushes">-</div>
            <div class="today-label">ä»Šæ—¥æ¨é€</div>
        </div>
    </div>
    <div class="ai-evaluation" id="ai-evaluation">
        <div class="evaluation-loading">
            <img src="/static/images/characters/loading.png" alt="åŠ è½½ä¸­" class="loading-heart-img">
            <span>æ­£åœ¨æ€è€ƒ...</span>
        </div>
    </div>
</div>

<!-- å†å²è®°å½•é¢æ¿ -->
<div id="history-panel" class="history-panel">
    <div class="history-content">
        <div class="history-header">
            <h3>ğŸ“š å†å²è¯„ä»·</h3>
            <button class="close-history-btn" onclick="toggleHistory()">âœ•</button>
        </div>
        <div id="evaluation-history" class="history-list">
            <p class="no-history">åŠ è½½ä¸­...</p>
        </div>
    </div>
</div>

<div class="toolbar cute-toolbar">
    <div class="toolbar-group">
        <label for="date-range">ğŸ“… æ—¶é—´èŒƒå›´:</label>
        <select id="date-range" class="form-control">
            <option value="7">æœ€è¿‘ 7 å¤©</option>
            <option value="14">æœ€è¿‘ 14 å¤©</option>
            <option value="30" selected>æœ€è¿‘ 30 å¤©</option>
            <option value="90">æœ€è¿‘ 90 å¤©</option>
        </select>
    </div>

    <div class="toolbar-group">
        <label for="repo-filter">ğŸ“ ä»“åº“:</label>
        <select id="repo-filter" class="form-control">
            <option value="">å…¨éƒ¨ä»“åº“</option>
        </select>
    </div>

    <button id="refresh-btn" class="btn btn-primary">
        <span class="btn-icon">ğŸ”„</span>
        <span>åˆ·æ–°ä¸€ä¸‹</span>
    </button>
</div>

<div class="dashboard">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-cards">
        <div class="stat-card cute-card">
            <div class="stat-icon">ğŸ’–</div>
            <div class="stat-value" id="total-commits">-</div>
            <div class="stat-label">æ€»æäº¤æ•°</div>
        </div>
        <div class="stat-card cute-card">
            <div class="stat-icon">âœˆï¸</div>
            <div class="stat-value" id="total-pushes">-</div>
            <div class="stat-label">æ€»æ¨é€æ•°</div>
        </div>
        <div class="stat-card cute-card">
            <div class="stat-icon">ğŸŒŸ</div>
            <div class="stat-value" id="active-repos">-</div>
            <div class="stat-label">æ´»è·ƒä»“åº“</div>
        </div>
        <div class="stat-card cute-card">
            <div class="stat-icon">ğŸ“ˆ</div>
            <div class="stat-value" id="avg-commits">-</div>
            <div class="stat-label">æ—¥å‡æäº¤</div>
        </div>
    </div>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <div class="charts-container">
        <div class="chart-card cute-chart-card">
            <h3>ğŸ“Š æäº¤è¶‹åŠ¿ âœ¨</h3>
            <canvas id="trend-chart"></canvas>
        </div>

        <div class="chart-card cute-chart-card">
            <h3>ğŸ° ä»“åº“åˆ†å¸ƒ âœ¨</h3>
            <canvas id="repo-chart"></canvas>
        </div>

        <div class="chart-card cute-chart-card">
            <h3>ğŸŒ¸ åˆ†æ”¯æ´»è·ƒåº¦ âœ¨</h3>
            <canvas id="branch-chart"></canvas>
        </div>
    </div>

    <!-- æœ€è¿‘æ´»åŠ¨ -->
    <div class="recent-activities cute-section">
        <h3>âœ¨ æœ€è¿‘æ´»åŠ¨ âœ¨</h3>
        <div id="activities-list" class="activities-list">
            <div class="cute-loading">
                <div class="loading-spinner">â™¡</div>
                <span>åŠ è½½ä¸­...</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script>
// åŠ è½½ä»Šæ—¥ç»Ÿè®¡å’ŒAIè¯„ä»·
async function loadTodaySummary(forceRefresh = false) {
    try {
        const url = forceRefresh ? '/api/v1/today-summary?force_refresh=true' : '/api/v1/today-summary';
        const response = await fetch(url);
        const result = await response.json();

        if (result.success) {
            const { stats, evaluation } = result.data;

            // æ›´æ–°ç»Ÿè®¡æ•°å­—
            document.getElementById('today-commits').textContent = stats.commit_count;
            document.getElementById('today-pushes').textContent = stats.push_count;

            // æ›´æ–°AIè¯„ä»·
            const evaluationDiv = document.getElementById('ai-evaluation');
            if (evaluation) {
                // æœ‰è¯„ä»·å†…å®¹æ—¶æ˜¾ç¤º
                evaluationDiv.style.display = 'block';

                // å°†è¯„ä»·æ–‡æœ¬å­˜å‚¨åˆ° data å±æ€§ä¸­,é¿å… HTML æ³¨å…¥é—®é¢˜
                const button = document.createElement('button');
                button.className = 'save-evaluation-btn';
                button.textContent = 'ğŸ’¾ è®°å½•è¯„ä»·';
                button.dataset.evaluation = evaluation;
                button.onclick = function() {
                    saveEvaluation(this.dataset.evaluation);
                };

                evaluationDiv.innerHTML = `
                    <div class="evaluation-content fade-in">
                        <img src="/static/images/characters/mascot.png" alt="è§’è‰²" class="evaluation-avatar-img" onerror="this.style.display='none'">
                        <div class="evaluation-text-wrapper">
                            <div class="evaluation-text"></div>
                        </div>
                    </div>
                `;

                // å®‰å…¨åœ°æ’å…¥è¯„ä»·æ–‡æœ¬å’ŒæŒ‰é’®
                const textWrapper = evaluationDiv.querySelector('.evaluation-text-wrapper');
                textWrapper.querySelector('.evaluation-text').textContent = evaluation;
                textWrapper.appendChild(button);
            } else {
                // æ²¡æœ‰è¯„ä»·å†…å®¹æ—¶éšè—
                evaluationDiv.style.display = 'none';
            }
        }
    } catch (error) {
        console.error('åŠ è½½ä»Šæ—¥ç»Ÿè®¡å¤±è´¥:', error);
    }
}

// åˆ·æ–°ä»Šæ—¥è¯„ä»·(å¼ºåˆ¶åˆ·æ–°ç¼“å­˜)
document.getElementById('refresh-today-btn').addEventListener('click', () => {
    const evaluationDiv = document.getElementById('ai-evaluation');
    evaluationDiv.innerHTML = `
        <div class="evaluation-loading">
            <img src="/static/images/characters/loading.png" alt="åŠ è½½ä¸­" class="loading-heart-img">
            <span>æ­£åœ¨æ€è€ƒ...</span>
        </div>
    `;
    loadTodaySummary(true);  // ä¼ å…¥ true å¼ºåˆ¶åˆ·æ–°
});

// é¡µé¢åŠ è½½æ—¶è·å–ä»Šæ—¥ç»Ÿè®¡
document.addEventListener('DOMContentLoaded', () => {
    loadTodaySummary();
    loadSavedEvaluations();
});

// ä¿å­˜è¯„ä»·åˆ°æœ¬åœ°å­˜å‚¨
function saveEvaluation(evaluationText) {
    const today = new Date().toLocaleDateString('zh-CN');
    const saved = JSON.parse(localStorage.getItem('gitsee_evaluations') || '[]');

    // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²ç»ä¿å­˜è¿‡
    const existingIndex = saved.findIndex(item => item.date === today);
    if (existingIndex >= 0) {
        if (!confirm('ä»Šå¤©å·²ç»è®°å½•è¿‡è¯„ä»·äº†,æ˜¯å¦è¦†ç›–?')) {
            return;
        }
        saved[existingIndex] = {
            date: today,
            evaluation: evaluationText,
            timestamp: new Date().toISOString()
        };
    } else {
        saved.push({
            date: today,
            evaluation: evaluationText,
            timestamp: new Date().toISOString()
        });
    }

    localStorage.setItem('gitsee_evaluations', JSON.stringify(saved));
    alert('è¯„ä»·å·²è®°å½•~ ğŸ’–');

    // åˆ·æ–°å†å²è®°å½•åˆ—è¡¨
    loadSavedEvaluations();
}

// åŠ è½½ä¿å­˜çš„è¯„ä»·åˆ—è¡¨
function loadSavedEvaluations() {
    const saved = JSON.parse(localStorage.getItem('gitsee_evaluations') || '[]');
    const historyContainer = document.getElementById('evaluation-history');

    if (saved.length === 0) {
        historyContainer.innerHTML = '<p class="no-history">æš‚æ— å†å²è®°å½•~</p>';
        return;
    }

    // æŒ‰æ—¶é—´å€’åºæ’åˆ—
    saved.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

    historyContainer.innerHTML = saved.map((item, index) => `
        <div class="history-item">
            <div class="history-date">${item.date}</div>
            <div class="history-evaluation">${item.evaluation}</div>
            <button class="delete-history-btn" onclick="deleteEvaluation(${index})">ğŸ—‘ï¸ åˆ é™¤</button>
        </div>
    `).join('');
}

// åˆ é™¤ä¿å­˜çš„è¯„ä»·
function deleteEvaluation(index) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—?')) {
        return;
    }

    const saved = JSON.parse(localStorage.getItem('gitsee_evaluations') || '[]');
    saved.splice(index, 1);
    localStorage.setItem('gitsee_evaluations', JSON.stringify(saved));
    loadSavedEvaluations();
}

// åˆ‡æ¢å†å²è®°å½•é¢æ¿æ˜¾ç¤º
function toggleHistory() {
    const panel = document.getElementById('history-panel');
    panel.classList.toggle('show');
}
</script>
{% endblock %}
