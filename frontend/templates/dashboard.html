{% extends "base.html" %}

{% block title %}ä¸»é¡µ - PEEP GIT{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<!-- ä»Šæ—¥ç»Ÿè®¡å¡ç‰‡ -->
<div class="today-summary-card cute-today-card">
    <div class="today-header">
        <h2 class="today-title">ğŸ“… ä»Šæ—¥æ¦‚è§ˆ</h2>
        <button id="refresh-today-btn" class="btn-icon-only" title="åˆ·æ–°ä»Šæ—¥è¯„ä»·">
            ğŸ”„
        </button>
    </div>
    <div class="today-stats">
        <div class="today-stat">
            <div class="today-icon">ğŸ’</div>
            <div class="today-count" id="today-commits">-</div>
            <div class="today-label">ä»Šæ—¥æäº¤</div>
        </div>
        <div class="today-stat">
            <div class="today-icon">âœˆï¸</div>
            <div class="today-count" id="today-pushes">-</div>
            <div class="today-label">ä»Šæ—¥æ¨é€</div>
        </div>
    </div>
    <div class="ai-evaluation" id="ai-evaluation">
        <div class="evaluation-loading">
            <div class="loading-heart">â™¡</div>
            <span>èŒå¦¹é…±æ­£åœ¨æ€è€ƒ...</span>
        </div>
    </div>
</div>

<div class="toolbar cute-toolbar">
    <div class="toolbar-group">
        <label for="date-range">ğŸ“… æ—¶é—´èŒƒå›´:</label>
        <select id="date-range" class="form-control">
            <option value="7">æœ€è¿‘ 7 å¤©</option>
            <option value="14">æœ€è¿‘ 14 å¤©</option>
            <option value="30" selected>æœ€è¿‘ 30 å¤©</option>
            <option value="90">æœ€è¿‘ 90 å¤©</option>
        </select>
    </div>

    <div class="toolbar-group">
        <label for="repo-filter">ğŸ“ ä»“åº“:</label>
        <select id="repo-filter" class="form-control">
            <option value="">å…¨éƒ¨ä»“åº“</option>
        </select>
    </div>

    <button id="refresh-btn" class="btn btn-primary">
        <span class="btn-icon">ğŸ”„</span>
        <span>åˆ·æ–°ä¸€ä¸‹</span>
    </button>
</div>

<div class="dashboard">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-cards">
        <div class="stat-card cute-card">
            <div class="stat-icon">ğŸ’–</div>
            <div class="stat-value" id="total-commits">-</div>
            <div class="stat-label">æ€»æäº¤æ•°</div>
        </div>
        <div class="stat-card cute-card">
            <div class="stat-icon">âœˆï¸</div>
            <div class="stat-value" id="total-pushes">-</div>
            <div class="stat-label">æ€»æ¨é€æ•°</div>
        </div>
        <div class="stat-card cute-card">
            <div class="stat-icon">ğŸŒŸ</div>
            <div class="stat-value" id="active-repos">-</div>
            <div class="stat-label">æ´»è·ƒä»“åº“</div>
        </div>
        <div class="stat-card cute-card">
            <div class="stat-icon">ğŸ“ˆ</div>
            <div class="stat-value" id="avg-commits">-</div>
            <div class="stat-label">æ—¥å‡æäº¤</div>
        </div>
    </div>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <div class="charts-container">
        <div class="chart-card cute-chart-card">
            <h3>ğŸ“Š æäº¤è¶‹åŠ¿ âœ¨</h3>
            <canvas id="trend-chart"></canvas>
        </div>

        <div class="chart-card cute-chart-card">
            <h3>ğŸ° ä»“åº“åˆ†å¸ƒ âœ¨</h3>
            <canvas id="repo-chart"></canvas>
        </div>

        <div class="chart-card cute-chart-card">
            <h3>ğŸŒ¸ åˆ†æ”¯æ´»è·ƒåº¦ âœ¨</h3>
            <canvas id="branch-chart"></canvas>
        </div>
    </div>

    <!-- æœ€è¿‘æ´»åŠ¨ -->
    <div class="recent-activities cute-section">
        <h3>âœ¨ æœ€è¿‘æ´»åŠ¨ âœ¨</h3>
        <div id="activities-list" class="activities-list">
            <div class="cute-loading">
                <div class="loading-spinner">â™¡</div>
                <span>åŠ è½½ä¸­...</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script>
// åŠ è½½ä»Šæ—¥ç»Ÿè®¡å’ŒAIè¯„ä»·
async function loadTodaySummary() {
    try {
        const response = await fetch('/api/v1/today-summary');
        const result = await response.json();

        if (result.success) {
            const { stats, evaluation } = result.data;

            // æ›´æ–°ç»Ÿè®¡æ•°å­—
            document.getElementById('today-commits').textContent = stats.commit_count;
            document.getElementById('today-pushes').textContent = stats.push_count;

            // æ›´æ–°AIè¯„ä»·
            const evaluationDiv = document.getElementById('ai-evaluation');
            if (evaluation) {
                evaluationDiv.innerHTML = `
                    <div class="evaluation-content fade-in">
                        <div class="evaluation-avatar">ğŸ‘§</div>
                        <div class="evaluation-text">${evaluation}</div>
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('åŠ è½½ä»Šæ—¥ç»Ÿè®¡å¤±è´¥:', error);
    }
}

// åˆ·æ–°ä»Šæ—¥è¯„ä»·
document.getElementById('refresh-today-btn').addEventListener('click', () => {
    const evaluationDiv = document.getElementById('ai-evaluation');
    evaluationDiv.innerHTML = `
        <div class="evaluation-loading">
            <div class="loading-heart">â™¡</div>
            <span>èŒå¦¹é…±æ­£åœ¨æ€è€ƒ...</span>
        </div>
    `;
    loadTodaySummary();
});

// é¡µé¢åŠ è½½æ—¶è·å–ä»Šæ—¥ç»Ÿè®¡
document.addEventListener('DOMContentLoaded', () => {
    loadTodaySummary();
});
</script>
{% endblock %}
