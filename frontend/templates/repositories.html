{% extends "base.html" %}

{% block title %}ä»“åº“ç®¡ç† - GitSee{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<style>
.repo-actions {
    display: flex;
    gap: 10px;
    align-items: center;
}

.btn-scan {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    margin-bottom: 20px;
}

.btn-scan:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.scan-options {
    display: none;
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.scan-options.active {
    display: block;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}

.form-group input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.repo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.repo-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s, box-shadow 0.2s;
}

.repo-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}

.repo-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
}

.repo-name {
    font-size: 18px;
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
}

.repo-path {
    font-size: 12px;
    color: #999;
    word-break: break-all;
}

.repo-status {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.repo-status.monitored {
    background: #d4edda;
    color: #155724;
}

.repo-status.unmonitored {
    background: #f8d7da;
    color: #721c24;
}

.repo-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin: 15px 0;
}

.stat-item {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 6px;
    text-align: center;
}

.stat-value {
    font-size: 20px;
    font-weight: 600;
    color: #667eea;
}

.stat-label {
    font-size: 12px;
    color: #666;
    margin-top: 4px;
}

.repo-actions {
    display: flex;
    gap: 8px;
    margin-top: 15px;
}

.btn-small {
    padding: 6px 12px;
    font-size: 13px;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-primary {
    background: #667eea;
    color: white;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-small:hover {
    opacity: 0.9;
    transform: scale(1.05);
}

.add-repo-form {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.add-repo-form h3 {
    margin-bottom: 15px;
}

.form-row {
    display: flex;
    gap: 10px;
    align-items: flex-end;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.loading-overlay.active {
    display: flex;
}

.spinner {
    background: white;
    padding: 30px;
    border-radius: 10px;
    text-align: center;
}
</style>
{% endblock %}

{% block content %}
<div class="repositories-page">
    <h2>ä»“åº“ç®¡ç†</h2>
    <p>ç®¡ç†å’Œç›‘æ§æ‚¨çš„ Git ä»“åº“</p>

    <!-- æ‰«ææŒ‰é’® -->
    <button id="scan-btn" class="btn-scan">
        <span>ğŸ” æ‰«æ Git ä»“åº“</span>
    </button>

    <!-- æ‰«æé€‰é¡¹ -->
    <div id="scan-options" class="scan-options">
        <h3>æ‰«æé€‰é¡¹</h3>
        <div class="form-group">
            <label>æ‰«æç›®å½•</label>
            <input type="text" id="scan-directories" placeholder="å¤šä¸ªç›®å½•ç”¨åˆ†å·åˆ†éš”,ç•™ç©ºåˆ™æ‰«æå¸¸è§ç›®å½•">
        </div>
        <div class="form-group">
            <label>æ‰«ææ·±åº¦</label>
            <input type="number" id="scan-depth" value="4" min="1" max="10">
        </div>
        <button id="start-scan-btn" class="btn btn-primary">å¼€å§‹æ‰«æ</button>
        <button id="cancel-scan-btn" class="btn btn-secondary">å–æ¶ˆ</button>
    </div>

    <!-- æ·»åŠ ä»“åº“è¡¨å• -->
    <div class="add-repo-form">
        <h3>æ‰‹åŠ¨æ·»åŠ ä»“åº“</h3>
        <div class="form-row">
            <div style="flex: 1;">
                <input type="text" id="add-repo-path" placeholder="è¾“å…¥ Git ä»“åº“è·¯å¾„">
            </div>
            <button id="add-repo-btn" class="btn btn-primary">æ·»åŠ </button>
        </div>
        <small style="color: #666;">ä¾‹å¦‚: C:\Users\YourName\projects\my-repo</small>
    </div>

    <!-- ä»“åº“åˆ—è¡¨ -->
    <h3 style="margin-top: 30px;">å·²ç›‘æ§ä»“åº“ (<span id="repo-count">0</span>)</h3>
    <div id="repo-list" class="repo-grid">
        <div class="loading">åŠ è½½ä¸­...</div>
    </div>
</div>

<!-- åŠ è½½é®ç½© -->
<div id="loading-overlay" class="loading-overlay">
    <div class="spinner">
        <div style="font-size: 40px; margin-bottom: 15px;">â³</div>
        <p id="loading-text">æ­£åœ¨å¤„ç†...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let repos = [];

// åŠ è½½ä»“åº“åˆ—è¡¨
async function loadRepos() {
    try {
        showLoading('åŠ è½½ä»“åº“åˆ—è¡¨...');
        const response = await fetch('/api/v1/repos/list');
        const result = await response.json();

        if (result.success) {
            repos = result.data.repos;
            renderRepos();
        } else {
            console.error('åŠ è½½å¤±è´¥:', result.error);
        }
    } catch (error) {
        console.error('åŠ è½½å¤±è´¥:', error);
    } finally {
        hideLoading();
    }
}

// æ¸²æŸ“ä»“åº“åˆ—è¡¨
function renderRepos() {
    const container = document.getElementById('repo-list');
    document.getElementById('repo-count').textContent = repos.length;

    if (repos.length === 0) {
        container.innerHTML = '<div class="no-data">æš‚æ— ç›‘æ§ä»“åº“,è¯·æ‰«ææˆ–æ‰‹åŠ¨æ·»åŠ </div>';
        return;
    }

    container.innerHTML = repos.map(repo => `
        <div class="repo-card">
            <div class="repo-header">
                <div>
                    <div class="repo-name">${repo.repo_name}</div>
                    <div class="repo-path" title="${repo.repo_path}">${repo.repo_path}</div>
                </div>
                <span class="repo-status ${repo.is_monitored ? 'monitored' : 'unmonitored'}">
                    ${repo.is_monitored ? 'âœ“ å·²ç›‘æ§' : 'âœ— æœªç›‘æ§'}
                </span>
            </div>

            <div class="repo-stats">
                <div class="stat-item">
                    <div class="stat-value">${repo.total_commits || 0}</div>
                    <div class="stat-label">æäº¤æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${repo.total_pushes || 0}</div>
                    <div class="stat-label">æ¨é€æ•°</div>
                </div>
            </div>

            ${repo.last_activity_time ? `
                <div style="font-size: 12px; color: #999; margin: 10px 0;">
                    æœ€åæ´»åŠ¨: ${formatDateTime(repo.last_activity_time)}
                </div>
            ` : ''}

            ${repo.current_branch ? `
                <div style="font-size: 13px; color: #666; margin: 5px 0;">
                    <strong>åˆ†æ”¯:</strong> ${repo.current_branch}
                </div>
            ` : ''}

            ${repo.remote_url ? `
                <div style="font-size: 12px; color: #999; margin: 5px 0;">
                    <strong>è¿œç¨‹:</strong> ${repo.remote_url}
                </div>
            ` : ''}

            <div class="repo-actions">
                ${repo.is_monitored
                    ? `<button class="btn-small btn-danger" onclick="uninstallHook('${encodeURIComponent(repo.repo_path)}')">å¸è½½ Hook</button>`
                    : `<button class="btn-small btn-success" onclick="installHook('${encodeURIComponent(repo.repo_path)}')">å®‰è£… Hook</button>`
                }
                <button class="btn-small btn-secondary" onclick="deleteRepo('${encodeURIComponent(repo.repo_path)}')">åˆ é™¤</button>
            </div>
        </div>
    `).join('');
}

// æ‰«æä»“åº“
async function scanRepos() {
    const directories = document.getElementById('scan-directories').value;
    const depth = parseInt(document.getElementById('scan-depth').value);

    const requestData = {};

    if (directories) {
        requestData.directories = directories.split(';').map(d => d.trim());
    }

    requestData.max_depth = depth;

    try {
        showLoading('æ­£åœ¨æ‰«æ Git ä»“åº“...');
        const response = await fetch('/api/v1/repos/scan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
        });

        const result = await response.json();

        if (result.success) {
            const { count, repos: foundRepos } = result.data;

            if (count === 0) {
                alert('æœªæ‰¾åˆ° Git ä»“åº“');
            } else {
                // æ˜¾ç¤ºæ‰¾åˆ°çš„ä»“åº“
                const message = `æ‰¾åˆ° ${count} ä¸ª Git ä»“åº“\n\næ˜¯å¦å…¨éƒ¨æ·»åŠ åˆ°ç›‘æ§åˆ—è¡¨?`;
                if (confirm(message)) {
                    await batchAddRepos(foundRepos.map(r => r.path));
                } else {
                    // è®©ç”¨æˆ·é€‰æ‹©
                    const selectedRepos = foundRepos.filter(r =>
                        confirm(`æ·»åŠ ä»“åº“ "${r.name}"?\nè·¯å¾„: ${r.path}`)
                    );
                    await batchAddRepos(selectedRepos.map(r => r.path));
                }
            }
        } else {
            alert('æ‰«æå¤±è´¥: ' + result.error);
        }
    } catch (error) {
        console.error('æ‰«æå¤±è´¥:', error);
        alert('æ‰«æå¤±è´¥: ' + error.message);
    } finally {
        hideLoading();
    }
}

// æ‰¹é‡æ·»åŠ ä»“åº“
async function batchAddRepos(repoPaths) {
    if (repoPaths.length === 0) return;

    try {
        showLoading(`æ­£åœ¨æ·»åŠ  ${repoPaths.length} ä¸ªä»“åº“...`);
        const response = await fetch('/api/v1/repos/batch-add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                repo_paths: repoPaths,
                install_hooks: true
            })
        });

        const result = await response.json();

        if (result.success) {
            const { total, successful, failed } = result.data;
            alert(`æ·»åŠ å®Œæˆ!\næ€»è®¡: ${total}\næˆåŠŸ: ${successful}\nå¤±è´¥: ${failed}`);
            await loadRepos();
        } else {
            alert('æ·»åŠ å¤±è´¥: ' + result.error);
        }
    } catch (error) {
        console.error('æ·»åŠ å¤±è´¥:', error);
        alert('æ·»åŠ å¤±è´¥: ' + error.message);
    } finally {
        hideLoading();
    }
}

// æ‰‹åŠ¨æ·»åŠ ä»“åº“
async function addRepo() {
    const repoPath = document.getElementById('add-repo-path').value.trim();

    if (!repoPath) {
        alert('è¯·è¾“å…¥ä»“åº“è·¯å¾„');
        return;
    }

    try {
        showLoading('æ­£åœ¨æ·»åŠ ä»“åº“...');
        const response = await fetch('/api/v1/repos/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                repo_path: repoPath,
                install_hook: true
            })
        });

        const result = await response.json();

        if (result.success) {
            alert('ä»“åº“æ·»åŠ æˆåŠŸ!');
            document.getElementById('add-repo-path').value = '';
            await loadRepos();
        } else {
            alert('æ·»åŠ å¤±è´¥: ' + result.error);
        }
    } catch (error) {
        console.error('æ·»åŠ å¤±è´¥:', error);
        alert('æ·»åŠ å¤±è´¥: ' + error.message);
    } finally {
        hideLoading();
    }
}

// å®‰è£… Hook
async function installHook(repoPath) {
    repoPath = decodeURIComponent(repoPath);

    if (!confirm(`ç¡®å®šè¦ä¸ºä»¥ä¸‹ä»“åº“å®‰è£… Hook å—?\n${repoPath}`)) {
        return;
    }

    try {
        showLoading('æ­£åœ¨å®‰è£… Hook...');
        const response = await fetch(`/api/v1/repos/${encodeURIComponent(repoPath)}/install-hook`, {
            method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
            alert('Hook å®‰è£…æˆåŠŸ!');
            await loadRepos();
        } else {
            alert('Hook å®‰è£…å¤±è´¥: ' + result.error);
        }
    } catch (error) {
        console.error('Hook å®‰è£…å¤±è´¥:', error);
        alert('Hook å®‰è£…å¤±è´¥: ' + error.message);
    } finally {
        hideLoading();
    }
}

// å¸è½½ Hook
async function uninstallHook(repoPath) {
    repoPath = decodeURIComponent(repoPath);

    if (!confirm(`ç¡®å®šè¦ä¸ºä»¥ä¸‹ä»“åº“å¸è½½ Hook å—?\n${repoPath}`)) {
        return;
    }

    try {
        showLoading('æ­£åœ¨å¸è½½ Hook...');
        const response = await fetch(`/api/v1/repos/${encodeURIComponent(repoPath)}/uninstall-hook`, {
            method: 'POST'
        });

        const result = await response.json();

        if (result.success) {
            alert('Hook å¸è½½æˆåŠŸ!');
            await loadRepos();
        } else {
            alert('Hook å¸è½½å¤±è´¥: ' + result.error);
        }
    } catch (error) {
        console.error('Hook å¸è½½å¤±è´¥:', error);
        alert('Hook å¸è½½å¤±è´¥: ' + error.message);
    } finally {
        hideLoading();
    }
}

// åˆ é™¤ä»“åº“
async function deleteRepo(repoPath) {
    repoPath = decodeURIComponent(repoPath);

    if (!confirm(`ç¡®å®šè¦åˆ é™¤ä»¥ä¸‹ä»“åº“å—?\n${repoPath}\n\nè¿™å°†ä¸ä¼šåˆ é™¤å®é™…ä»“åº“æ–‡ä»¶,åªæ˜¯ä»ç›‘æ§åˆ—è¡¨ä¸­ç§»é™¤ã€‚`)) {
        return;
    }

    try {
        const response = await fetch(`/api/v1/repos/${encodeURIComponent(repoPath)}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            alert('ä»“åº“å·²åˆ é™¤!');
            await loadRepos();
        } else {
            alert('åˆ é™¤å¤±è´¥: ' + result.error);
        }
    } catch (error) {
        console.error('åˆ é™¤å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
    }
}

// æ˜¾ç¤ºåŠ è½½é®ç½©
function showLoading(text) {
    document.getElementById('loading-text').textContent = text;
    document.getElementById('loading-overlay').classList.add('active');
}

// éšè—åŠ è½½é®ç½©
function hideLoading() {
    document.getElementById('loading-overlay').classList.remove('active');
}

// æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
function formatDateTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString('zh-CN');
}

// äº‹ä»¶ç›‘å¬
document.getElementById('scan-btn').addEventListener('click', () => {
    document.getElementById('scan-options').classList.toggle('active');
});

document.getElementById('cancel-scan-btn').addEventListener('click', () => {
    document.getElementById('scan-options').classList.remove('active');
});

document.getElementById('start-scan-btn').addEventListener('click', scanRepos);

document.getElementById('add-repo-btn').addEventListener('click', addRepo);

document.getElementById('add-repo-path').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        addRepo();
    }
});

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    loadRepos();
});
</script>
{% endblock %}
