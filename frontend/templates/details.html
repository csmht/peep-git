{% extends "base.html" %}

{% block title %}è¯¦ç»†è®°å½• - PEEP GIT{% endblock %}

{% block content %}
<div class="details-page">
    <h2 class="cute-section-title">ğŸ“‹ è¯¦ç»†è®°å½•æœ¬</h2>

    <div class="filter-bar cute-filter-bar">
        <select id="activity-type-filter" class="form-control">
            <option value="">ğŸ€ å…¨éƒ¨ç±»å‹</option>
            <option value="commit">ğŸ’ æäº¤</option>
            <option value="push">ğŸš€ æ¨é€</option>
        </select>

        <input type="text" id="repo-search" class="form-control" placeholder="ğŸ” æœç´¢ä»“åº“...">

        <button id="export-btn" class="btn btn-secondary">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
    </div>

    <div class="table-container cute-table-container">
        <table class="data-table cute-table">
            <thead>
                <tr>
                    <th>â° æ—¶é—´</th>
                    <th>ğŸ·ï¸ ç±»å‹</th>
                    <th>ğŸ“¦ ä»“åº“</th>
                    <th>ğŸŒ¿ åˆ†æ”¯</th>
                    <th>ğŸ”– å“ˆå¸Œ</th>
                    <th>ğŸ’¬ æ¶ˆæ¯</th>
                    <th>ğŸ‘¤ ä½œè€…</th>
                </tr>
            </thead>
            <tbody id="details-table-body">
                <tr>
                    <td colspan="7" class="loading">åŠ è½½ä¸­...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="pagination cute-pagination">
        <button id="prev-page" class="btn btn-secondary" disabled>â—€ ä¸Šä¸€é¡µ</button>
        <span id="page-info">ç¬¬ 1 é¡µ</span>
        <button id="next-page" class="btn btn-secondary">ä¸‹ä¸€é¡µ â–¶</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
const pageSize = 20;

// åŠ è½½è¯¦ç»†è®°å½•
async function loadDetails() {
    const activityType = document.getElementById('activity-type-filter').value;
    const repoSearch = document.getElementById('repo-search').value;

    const params = new URLSearchParams({
        page: currentPage,
        page_size: pageSize
    });

    if (activityType) params.append('activity_type', activityType);
    if (repoSearch) params.append('repo_path', repoSearch);

    try {
        const response = await fetch(`/api/v1/activities?${params}`);
        const result = await response.json();

        if (result.success) {
            renderDetailsTable(result.data.activities);
            updatePagination(result.data.total);
        }
    } catch (error) {
        console.error('åŠ è½½è¯¦ç»†è®°å½•å¤±è´¥:', error);
    }
}

// æ¸²æŸ“è¡¨æ ¼
function renderDetailsTable(activities) {
    const tbody = document.getElementById('details-table-body');

    if (activities.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="no-data">æš‚æ— æ•°æ®</td></tr>';
        return;
    }

    tbody.innerHTML = activities.map(activity => `
        <tr>
            <td>${formatDateTime(activity.timestamp)}</td>
            <td><span class="badge badge-${activity.activity_type}">${activity.activity_type === 'commit' ? 'æäº¤' : 'æ¨é€'}</span></td>
            <td title="${activity.repo_path}">${getRepoName(activity.repo_path)}</td>
            <td>${activity.branch_name}</td>
            <td><code>${activity.commit_hash.substring(0, 7)}</code></td>
            <td title="${activity.commit_message}">${truncate(activity.commit_message, 50)}</td>
            <td>${activity.author_name || '-'}</td>
        </tr>
    `).join('');
}

// æ›´æ–°åˆ†é¡µ
function updatePagination(total) {
    const totalPages = Math.ceil(total / pageSize);
    document.getElementById('page-info').textContent = `ç¬¬ ${currentPage} / ${totalPages} é¡µ`;
    document.getElementById('prev-page').disabled = currentPage <= 1;
    document.getElementById('next-page').disabled = currentPage >= totalPages;
}

// æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
function formatDateTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString('zh-CN');
}

// è·å–ä»“åº“åç§°
function getRepoName(path) {
    return path.split('/').pop();
}

// æˆªæ–­æ–‡æœ¬
function truncate(text, length) {
    if (!text) return '-';
    return text.length > length ? text.substring(0, length) + '...' : text;
}

// äº‹ä»¶ç›‘å¬
document.getElementById('prev-page').addEventListener('click', () => {
    if (currentPage > 1) {
        currentPage--;
        loadDetails();
    }
});

document.getElementById('next-page').addEventListener('click', () => {
    currentPage++;
    loadDetails();
});

document.getElementById('activity-type-filter').addEventListener('change', () => {
    currentPage = 1;
    loadDetails();
});

document.getElementById('repo-search').addEventListener('input', debounce(() => {
    currentPage = 1;
    loadDetails();
}, 500));

document.getElementById('export-btn').addEventListener('click', async () => {
    const activityType = document.getElementById('activity-type-filter').value;
    const params = new URLSearchParams({ format: 'csv' });
    if (activityType) params.append('activity_type', activityType);

    window.location.href = `/api/v1/export?${params}`;
});

// é˜²æŠ–å‡½æ•°
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// åˆå§‹åŠ è½½
loadDetails();
</script>
{% endblock %}
